#!/usr/bin/env bash
set -e

if [ -z "$1" ]; then
  echo "Usage: $0 <vpc-id>"
  exit 1
fi

VPC_ID=$1
REGION="ap-northeast-1"

echo "Deleting resources for VPC: $VPC_ID"

# --- Detach and delete IGWs ---
IGW_IDS=$(aws ec2 describe-internet-gateways \
  --filters "Name=attachment.vpc-id,Values=$VPC_ID" \
  --query "InternetGateways[].InternetGatewayId" \
  --output text --region $REGION)

for IGW_ID in $IGW_IDS; do
  echo "Detaching and deleting IGW: $IGW_ID"
  aws ec2 detach-internet-gateway --internet-gateway-id $IGW_ID --vpc-id $VPC_ID --region $REGION || true
  aws ec2 delete-internet-gateway --internet-gateway-id $IGW_ID --region $REGION
done

# --- Delete subnets ---
SUBNET_IDS=$(aws ec2 describe-subnets \
  --filters "Name=vpc-id,Values=$VPC_ID" \
  --query "Subnets[].SubnetId" \
  --output text --region $REGION)

for SUBNET_ID in $SUBNET_IDS; do
  echo "Deleting subnet: $SUBNET_ID"
  aws ec2 delete-subnet --subnet-id $SUBNET_ID --region $REGION
done

# --- Delete non-main route tables ---
RT_IDS=$(aws ec2 describe-route-tables \
  --filters "Name=vpc-id,Values=$VPC_ID" \
  --query "RouteTables[?Associations[?Main!=true]].RouteTableId" \
  --output text --region $REGION)

for RT_ID in $RT_IDS; do
  echo "Deleting route table: $RT_ID"
  aws ec2 delete-route-table --route-table-id $RT_ID --region $REGION || true
done

# --- Delete any custom security groups ---
SG_IDS=$(aws ec2 describe-security-groups \
  --filters "Name=vpc-id,Values=$VPC_ID" \
  --query "SecurityGroups[?GroupName!='default'].GroupId" \
  --output text --region $REGION)

for SG_ID in $SG_IDS; do
  echo "Deleting security group: $SG_ID"
  aws ec2 delete-security-group --group-id $SG_ID --region $REGION || true
done

# --- Finally delete the VPC ---
echo "Deleting VPC: $VPC_ID"
aws ec2 delete-vpc --vpc-id $VPC_ID --region $REGION

echo "Deleted VPC $VPC_ID and all related resources."
